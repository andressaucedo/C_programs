/*booksave.c- saves structs containing book entries to file using binary read/write and prints the data*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "books.h"

int printdat(struct book biblio[MAXBKS], FILE *pbooks);
int size = sizeof(struct book);

int main(void)
{
  struct book biblio[MAXBKS]; //array of structs
  int index,count; 
  int filecount; //the number of entries which relates to the biblio array
  FILE * pbooks;
  char filename[] = "books.dat";

  if((pbooks = fopen(filename,"a+b")) == NULL)
  {
    fprintf(stderr,"ERROR: Cant open file %s\n",filename);
    exit(1);
  }
  rewind(pbooks);

  filecount = printdat(biblio, pbooks);
  count = filecount;

  if(count == MAXBKS)
  {
    fprintf(stderr,"%s file is full.\n",filename);
    exit(2);
  }

  fputs("Please add Entries.\n"
        "[Enter] to stop: \n"
        "Book Title: ",stdout);

  while(count < MAXBKS && fgets(biblio[count].title, sizeof(biblio[count].title),stdin) != NULL && biblio[count].title[0] != '\0' && biblio[count].title[0] != '\n')
  {
    fputs("Author: ",stdout);
    fgets(biblio[count].author,sizeof(biblio[count].author),stdin);
    fputs("Price: ",stdout);
    fscanf(stdin, "%f",&biblio[count].price);
    while(getchar() != '\n'); //clean up trailing chars from fscanf
    putchar('\n');
    count++;
    if(count < MAXBKS)
    {
      fputs("Book Title: ",stdout);
    }
  }

  fputs("Here is a list of your books:\n",stdout);
  for(index = 0; index < count; index++)
  {
    fprintf(stdout,"%s  by:%s  $%.2f\n\n",biblio[index].title, biblio[index].author,biblio[index].price);
  }

  /*The following lines append our structs to the file*/
    fseek(pbooks, 0L, SEEK_END);
    /*writing to our .dat file starting where we left off at the count of
      currently existing book entries(filecount)*/
    fwrite(&biblio[filecount], size, count - filecount,pbooks);
    fclose(pbooks);

return 0;
}

